<!--Copyright © Microsoft Corporation. All rights reserved.
  适用于[License](https://github.com/microsoft/AI-System/blob/main/LICENSE)版权许可-->

# 8.1 推理系统简介

- [8.1 推理系统简介](#81-推理系统简介)
  - [8.1.1 对比推理与训练过程](#811-对比推理与训练过程)
  - [8.1.2 推理系统的优化目标与约束](#812-推理系统的优化目标与约束)
  - [小结与讨论](#小结与讨论)
  - [参考文献](#参考文献)
## 8.1.1 对比推理与训练过程


深度学习模型的生命周期

训练阶段:
- 数据处理
- 模型训练

推理阶段:
- 部署
- 推理


推理相比训练的新特点与挑战

- 模型被部署为长期运行的服务
  - 服务有明确对请求的低延迟高吞吐需求
- 推理有更苛刻的资源约束
  - 更小的内存，更低的功耗等
- 推理不需要反向传播梯度下降
  - 可以牺牲一定的数据精度
- 部署的设备型号更加多样
  - 需要定制化的优化


模型部署与推理实例

```
# Convert the Tensorflow or other framework model to Serving System model format (UFF).
…
uff_model = uff.from_tensorflow(tf_model, OUTPUT_NAMES)
# Import the UFF model to TensorRT and build an engine.
…
engine = trt.utils.uff_to_trt_engine(G_LOGGER, uff_model, parser, 1, 1 << 20)
# Get the test image. 
…
img = Image.open(path)
…
# Create the context for the engine
context = engine.create_execution_context()
...
# Copy input to device and execute model
… 
bindings = [int(d_input), int(d_output)]
…
cuda.memcpy_htod_async(d_input, img, stream)
context.enqueue(1, bindings, stream.handle, None)
# Last, get the prediction and transfer prediction back
…
cuda.memcpy_dtoh_async(output, d_output, stream)
…
print("Prediction: ", LABELS[np.argmax(output)])
>>> Prediction:  n01608432 kite # The result is right due to imagenet_1000.txt does not include 'seagull’.
```


## 8.1.2 推理系统的优化目标与约束

在线推荐系统的服务需求

例如某在线新闻APP公司希望部署内容个性化推荐服务并期望该服务能满足以下需求：

- 低延迟：
  - 互联网上推荐文章延迟（<100毫秒）
- 高吞吐：
  - 突发新闻驱动的暴增人群的吞吐量需求
- 扩展性：
  - 扩展到不断增长的庞大的用户群体
- 准确度：
  - 随着新闻和读者兴趣的变化提供准确的预测 

推理系统部署灵活性需求

机器学习服务的部署，优化和维护困难且容易出错
- 框架多样：
  - 大多数框架都是为训练设计和优化	
  - 开发人员需要将必要的软件组件拼凑在一起
  - 跨多个不断发展的框架集成和推理需求
- 硬件多样：
  - 多种部署硬件的支持

设计推理系统的优化目标

- 延迟(Latency):
  - 满足服务等级协议的延迟
- 吞吐量(Throughputs):
  - 暴增负载的吞吐量需求
- 效率(Efficiency): 
  - 高效率，低功耗使用GPU, CPU
- 灵活性(Flexibility): 
  - 支持多种框架, 提供构建不同应用的灵活性
- 扩展性(Scalability):
  - 扩展支持不断增长的用户或设备

推理系统的约束

- SLA对延迟的约束
- 资源约束
  - 设备端电池约束
  - 设备与服务端内存约束
  - 云端资源的预算约束
…
- 准确度(Accuracy)约束
  - 使用近似模型产生的一些误差可以接受

 ## 小结与讨论

深度学习推理系统设计需要考虑多目标和约束
推理系统相比传统服务系统有哪些新的挑战？
云和端的服务系统有何不同的侧重和挑战？

## 参考文献
- 
