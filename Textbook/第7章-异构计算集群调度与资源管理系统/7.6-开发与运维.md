<!--Copyright © Microsoft Corporation. All rights reserved.
  适用于[License](https://github.com/microsoft/AI-System/blob/main/LICENSE)版权许可-->

# 7.6 开发与运维

在之前的章节，我们已经介绍面向深度学习的集群管理系统的运行时与调度。本章将围绕工程实践中，关于集群管理系统开发，运维的话题进行展开。集群管理系统，也称作平台，是7x24小时的对公司内部使用或者对外提供服务的平台型服务，其本身的开发越来越敏捷，同时也需要有更加敏捷而高效的运维支持。本章将围绕开发与运维的整体内容展开。

[TOC]


## 7.6.1 平台功能模块与敏捷开发

平台本身由于功能众多，整体性质属于在线服务，业界一般通过敏捷开发的模式进行整体的开发与设计。一般平台中涉及以下重要服务和功能模块的开发与设计。

- 内核：调度器，运行时，管理GUI，权限管理，文件管理等。
  - 调度器设计可以兼顾深度学习特点例如资源局部性。
  - 运行时需要支持特定设备插件，能够将GPU，IB等设备注册进入运行时。
  - 由于深度学习作业主要输入输出为数据和模型，一般可使用文件系统存储即可，需要选用高效（NFS等）且容错（云存储）的文件系统提供支持。
- 监控与报警：性能监控，异常监控，报警系统等。
  - 除常见需要平台监控的性能指标，还要特别关注GPU等核心加速器的资源利用率等指标。
  - 报警系统也要除覆盖常见错误，还需要覆盖新服务与新硬件产生的错误与异常。
- 工具链：IDE，作业提交与调试工具，API(Restful)等。
  - IDE可以选用对Python和深度学习生态支持较好的开发环境。例如，基于浏览器的开发工具(Jupyter)或者插件化支持较好的本地客户端环境VS Code等。
  - 作业提交可以通过Web人工提交或者Restful API方便AutoML工具自动化提交。
  - 可以考虑支持远程SSH方便用户远程登录作业现场调试
- 应用市场：模型市场，镜像市场等。
  - 由于目前深度学习新的模型很多基于研究工作和开源模型与代码进行微调适配和扩展，模型训练框架主流框架也都是开源的，这就让平台方可以通过提供常用和优化版本的模型与框架镜像市场进而优化，管理和提升开发生产力。

不同的功能模块可以分配不同的工程师进行开发，通过[Scrum](https://en.wikipedia.org/wiki/Scrum_(software_development))敏捷开发机制，指定Sprint计划，并通过每日的Scrum进行规划反思与推进。

## 7.6.2 监控体系构建

通过构建完整的指标体系，能够让平台管理员和开发者对平台健康状况和系统负载运行状况一目了然，同时有助于对异常与错误进行诊断与归因分析。围绕异构资源管理系统，可以从以下方面设计指标， 进而通过数据驱动的方法提升运维效率。

#### ***全局监控***

可以通过围绕作业，服务，节点几个维度设计需要整体宏观监控的指标，并围绕团队的核心KPI设计效率，稳定性等全局指标，方便回查与评估。

#### ***性能监控***

可以围绕作业和硬件的性能进行监控设计，其中硬件的各种指标在作业执行时间的连接可以推导出作业的性能指标。对深度学习系统，尤其需要关注GPU的利用率等指标，这可以通过[NVML](https://developer.nvidia.com/nvidia-management-library-nvml)，[DCGM](https://developer.nvidia.com/dcgm)等工具构建指标导出器进行监控与获取。

#### ***服务与硬件稳定性监控***

可以观测和监控平台的各个模块的健康，通过被动汇报或者主动探测的机制，监测服务的存活状况。对硬件可以周期性运行测试，或者通过监控指标的异常进行判断。服务模块在设计之初就需要考虑暴露接口或者心跳机制设计，可以被监控系统更好的遥测。

#### ***报警***

监控系统可以在节点部署监控脚本(exporter)以及核心的时序数据库（例如，[Promethus](https://prometheus.io/), [Ganglia](http://ganglia.sourceforge.net/)等）进行监控数据收集，并通过可视化的系统(例如，[Grafana](https://grafana.com/)等)进行监控报表和可视化的展示。
报警系统（例如，[Alert Manager](https://prometheus.io/docs/alerting/latest/alertmanager/)）可以提前规划好报警规则与阈值，不断监控和分析监控系统中的指标是否违规，如果违规及时发送报警信息或者邮件。尤其对用户提交的作业，深度学习作业容易发生OOM，GPU容易出现阻塞或者ECC错误等问题，对于高频和影响较大的异常需要及时修复与处理。

## 7.6.3 测试

可以通过 以下几个方面进行系统测试保证平台的常见问题，早发现，早规避，主动出击保证平台软件代码和服务本身的可靠性。

#### ***单元测试***

平台的新增功能模块需要进行单元测试，保证逻辑的正确性。可以选用所使用的模块的开发语言的单元测试库进行单元测试用例的开发。保证函数和模块的正确性。并在回归测试中触发单元测试进行回测。

#### ***集成测试***

由于开源系统的应用越来越广泛，目前很多平台系统或多或少的模块会采用开源系统进行实现和部署，这就造成平台整体的集成测试变得尤为重要。可以在测试集群或者环境中进行集成测试。

#### ***压力测试***

对于平台，可以不间断的自动提交一些测试作业进行巡检，也可以定期进行压力测试检测服务功能的负载能力或硬件的稳定性。同时也可以考虑使用混沌测试这种缺陷注入机制，主动注入异常，提前修复和增强平台的稳定性。

#### ***回归测试***

一旦完成平台新功能开发或者在线热修复，需要进行回归测试保证符合之前系统假设。
回归测试是指修改了已有代码后，重新进行测试以确认修改没有引入新的错误或导致其他代码产生错误。由于当前平台属于在线服务，同时常常使用敏捷开发模式，这样十分容易产生软件缺陷，设计好回归测试的机制，对保证平台的正确性显得尤为重要。

## 7.6.4 平台部署与DevOps

可以通过CI/CD机制，持续集成，持续部署，也就是我们通常所说的[DevOps](https://en.wikipedia.org/wiki/DevOps)。平台本身的各个服务组件也可以打包为Docker镜像，通过Kubernetes等工具部署和管理相应服务。可以通过相关的工具（例如：jenkins），构建CI/CD的流水线，进而保证平台工程时开发新功能或者热修复(hotfix)后能够自动化走完完整的测试与部署流程，大幅提升开发与部署效率。


## 7.6.5 平台运维

#### ***DRI机制***

平台可以通过设计[DRI](https://about.gitlab.com/handbook/people-group/directly-responsible-individuals/)机制，让开发工程师轮岗进行值班与平台问题修复运维，这样不会产生开发与运维职责脱节，责任到位，热修复也会执行的更快。

#### ***事件管理***

对平台产生的系统报警和用户提交的问题事件(Incident)，可以通过一定的事件管理进行维护，并制定一定的SLA，保证指定时间内能够介入，缓解与修复，对高优先级的问题需要有相应策略引入更多人员与团队介入。

#### ***智能运维***

目前对于过于复杂问题，非结构化运维数据，以及希望数据驱动解决的运维问题，也可以考虑AIOps技术进行智能运维，主动介入与预测，互补于常规运维方法。

## 参考文献
- https://en.wikipedia.org/wiki/Scrum_(software_development)
- https://about.gitlab.com/handbook/people-group/directly-responsible-individuals/
- https://en.wikipedia.org/wiki/DevOps
- https://prometheus.io/docs/alerting/latest/alertmanager/
- https://grafana.com/
- https://prometheus.io/
- http://ganglia.sourceforge.net/